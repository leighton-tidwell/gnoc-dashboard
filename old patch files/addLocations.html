<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.3/js/bootstrap.bundle.min.js"></script>
<script type="text/javascript"
  src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>
<script src="https://unpkg.com/feather-icons/dist/feather.min.js"></script>
<script>

  // Global digest value for auth
  var digest = getFormDigest();
  // Get Digest
  var hostUrl = "https://intelshare.intelink.gov/sites/89cs/GNOC/";
  function getFormDigest() {
    console.log("Getting Form Digest..");
    $.support.cors = true;
    var _formDigest;
    $.ajax({
      url: hostUrl + "/_api/contextinfo",
      type: "POST",
      dataType: "json",

      headers: { "Accept": "application/json; odata=verbose" },
      xhrFields: { withCredentials: true },
      async: false,
      success: function (data) {
        _formDigest = data.d.GetContextWebInformation.FormDigestValue;
        console.log(data.d.GetContextWebInformation.FormDigestValue);
        console.log("Form Digest Done");

      },
      error: function () {
        console.log("Error Occured");
      }
    });

    return _formDigest;
  }

  var listName = "iata_list";
  var ticket_number = "";

  $(function () {
    //Grab all IATA
    var urlLoad = "https://intelshare.intelink.gov/sites/89cs/GNOC/_api/web/lists/getbytitle('iata_list')/items?$top=5000&$orderby=Title%20asc";
    $.ajax({
      url: urlLoad,
      async: false,
      method: "GET",
      headers: {
        "Accept": "application/json;odata=verbose"
      },
      success: function (data) {
        var total = 0;
        var allResults = data.d.results;
        if (Number(allResults.length) > 0) {
          var select = document.getElementById('iata_list');
          for (var i = 0; i < Number(allResults.length); i++) {
            // now search for location in tickets
            if(allResults[i].location != null){
              var location = getLocationInformation(allResults[i].Title).toUpperCase();
              console.log(location);
              if (location != "") {
                ticket_number = allResults[i].Id;
                itemProperties = { 'location': location.toUpperCase() };
                updateTicket(hostUrl, itemProperties, function () {
                  console.log(allResults[i].Title + " was updated with " + location + ".");
                }, function () {
                  console.log("An error has occured.");
                });
              }
            }
          }
        }
      },
      error: function (data) {
        //alert("Error: " + JSON.stringify(data));
      }
    });
  });

  function getLocationInformation(iata) {
    var urlLoad = "https://intelshare.intelink.gov/sites/89cs/GNOC/_api/web/lists/getbytitle('Missions')/items?$filter=Departure_IATA eq '" + iata + "'&$top=1&$orderby=Created%20desc";
    var location = "";
    $.ajax({
      url: urlLoad,
      async: false,
      method: "GET",
      headers: {
        "Accept": "application/json;odata=verbose"
      },
      success: function (data) {
        var allResults = data.d.results;
        if (Number(allResults.length) > 0) {
          location = allResults[0].Departure_Location;
        }
      },
      error: function (data) {
        //alert("Error: " + JSON.stringify(data));
      }
    });
    return location;
  }



  // Update flight ticket
  function updateTicket(webUrl, itemProperties, success, failure) {
    var itemType = "SP.Data.Iata_x005f_listListItem";
    itemProperties["__metadata"] = { "type": itemType };

    $.ajax({
      url: webUrl + "/_api/web/lists/getbytitle('" + listName + "')/items('" + ticket_number + "')",
      type: "POST",
      contentType: "application/json;odata=verbose",
      data: JSON.stringify(itemProperties),
      headers: {
        "Accept": "application/json;odata=verbose",
        "X-RequestDigest": digest,
        "IF-MATCH": "*", // Overwrite changes
        "X-HTTP-Method": "MERGE" // update operation
      },
      success: function (data) {
        success(data);
      },
      error: function (data) {
        failure(data);
      }
    });
  }

  // Get List Item Type metadata
  function GetItemTypeForListName(name) {
    return "SP.Data." + name.charAt(0).toUpperCase() + name.split(" ").join("").slice(1) + "ListItem";
  }
</script>