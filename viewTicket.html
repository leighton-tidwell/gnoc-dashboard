<html>

<head>
  <title>GNOC DV Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.3/css/bootstrap.min.css" />
  <link rel="stylesheet" href="./css/global.css" />

  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script type="text/javascript"
    src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.3/js/bootstrap.bundle.min.js"></script>
  <script type="text/javascript"
    src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>
  <script type="text/javascript"
    src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-filestyle/2.1.0/bootstrap-filestyle.min.js"></script>
  <script type="text/javascript" src="./js/user.js"></script>
  <script src="https://unpkg.com/feather-icons/dist/feather.min.js"></script>
  <script>

    // Get files: https://intelshare.intelink.gov/sites/89cs/GNOC/_api/web/lists/getbytitle('ticketAttachments')/items?$select=ticket_number,Attachments,AttachmentFiles&$expand=AttachmentFiles

    // To get ticket Number from URL
    var getUrlParameter = function getUrlParameter(sParam) {
      var sPageURL = window.location.search.substring(1),
        sURLVariables = sPageURL.split('&'),
        sParameterName,
        i;

      for (i = 0; i < sURLVariables.length; i++) {
        sParameterName = sURLVariables[i].split('=');

        if (sParameterName[0] === sParam) {
          return sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);
        }
      }
    };
    var ticket_number = getUrlParameter('ticket');
    var ticket_ID = 0;
    var ticket_status = "";
    var updateIds = [];

    // Get Digest for Auth purposes
    var hostUrl = "https://intelshare.intelink.gov/sites/89cs/GNOC/";
    var listName = "Tickets";
    function getFormDigest() {
      console.log("Getting Form Digest..");
      $.support.cors = true;
      var _formDigest;
      $.ajax({
        url: hostUrl + "/_api/contextinfo",
        type: "POST",
        dataType: "json",

        headers: { "Accept": "application/json; odata=verbose" },
        xhrFields: { withCredentials: true },
        async: false,
        success: function (data) {
          _formDigest = data.d.GetContextWebInformation.FormDigestValue;
          console.log(data.d.GetContextWebInformation.FormDigestValue);
          console.log("Form Digest Done");

        },
        error: function () {
          console.log("Error Occured");
        }
      });

      return _formDigest;
    }

    var digest = getFormDigest();

    $(function () {

      if (!checkPermissions("VklFVyBUSUNLRVQ=", false, true)) {
        $("html").remove();
      }

      // Permissions of content if page true and let page content run
      if (checkPermissions("VklFVyBUSUNLRVQ=", false, false)) {

        // page specific
        if (!checkPermissions("RURJVCBUSUNLRVQ=", "ticket_attachments_div", false)) {
          // if they cant edit ticket
          $("input").prop("disabled", true);
          $("textarea").prop("disabled", true);
          $("select").prop("disabled", true);
          $("button").remove();
        }
        checkPermissions("VElDS0VUIEFVVEhPUg==", "createdBy", false);
        checkPermissions("REVMRVRFIFRJQ0tFVA==", "deleteTicket", false);


        // nav
        checkPermissions("REFTSEJPQVJE", "dashboard_div", false);
        checkPermissions("RkxJR0hUIFNDSEVEVUxF", "flight_schedule_div", false);
        if (!checkPermissions("Q1JFQVRFIFRUUw==", "create_tts_div", false) && !checkPermissions("Q1JFQVRFIE1BU1RFUiBUVFM=", "create_master_tts_div", false) && !checkPermissions("VElDS0VUIFNFVFRJTkdT", "ticket_settings_div", false) && !checkPermissions("VklFVyBUSUNLRVRT", "view_tickets_div", false)) {
          $("#tickets_header_div").remove();
        }
        checkPermissions("Q1JFQVRFIFRUUw==", "create_tts_div", false);
        checkPermissions("Q1JFQVRFIE1BU1RFUiBUVFM=", "create_master_tts_div", false);
        checkPermissions("VElDS0VUIFNFVFRJTkdT", "ticket_settings_div", false);
        checkPermissions("VklFVyBUSUNLRVRT", "view_tickets_div", false);
        if (!checkPermissions("Q1JFQVRFIEZMSUdIVCBUSUNLRVQ=", "create_flight_ticket_div", false) && !checkPermissions("VklFVyBGTElHSFQgVElDS0VUUw==", "view_flight_tickets_div", false) && !checkPermissions("VklFVyBNSVNTSU9OUw==", "view_missions_div", false)) {
          $("#flight_tickets_header_div").remove();
        }
        checkPermissions("Q1JFQVRFIEZMSUdIVCBUSUNLRVQ=", "create_flight_ticket_div", false);
        checkPermissions("Q1JFQVRFIEZMSUdIVCBUSUNLRVQ=", "create_flight_ticket_icon_div", false);
        checkPermissions("VklFVyBGTElHSFQgVElDS0VUUw==", "view_flight_tickets_div", false);
        checkPermissions("VklFVyBNSVNTSU9OUw==", "view_missions_div", false);
        if (!checkPermissions("QUREIEEgQ0NJUg==", "add_a_ccir_div", false) && !checkPermissions("VklFVyBDQ0lSUw==", "view_ccirs_div", false)) {
          $("#ccir_header_div").remove();
        }
        checkPermissions("QUREIEEgQ0NJUg==", "add_a_ccir_div", false);
        checkPermissions("QUREIEEgQ0NJUg==", "add_a_ccir_icon_div", false);
        checkPermissions("VklFVyBDQ0lSUw==", "view_ccirs_div", false);
        if (!checkPermissions("MjQgSE9VUiBSRVBPUlQ=", "24_hour_report_div", false)) {
          $("#reports_header_div").remove();
        }
        checkPermissions("MjQgSE9VUiBSRVBPUlQ=", "24_hour_report_div", false);
        checkPermissions("Q09OVEFDVCBMSVNU", "contact_list_div", false);
        checkPermissions("V0VFS0VORCBUSUNLRVQgUkVQT1JU", "weekend_report_div", false);
        checkPermissions("TU9STklORyBTTElERVM=", "morning_slides_div", false);
        checkPermissions("UEVSU09OTkVMIFNUQVRT", "personnel_stats_div", false);
        checkPermissions("TUVUUklDUw==", "monthly_metrics_div", false);
        checkPermissions("UEVSTUlTU0lPTlM=", "permissions_div", false);

        $(":file").filestyle('dragdrop');
        // Populate DV Drop down
        var urlLoad = "https://intelshare.intelink.gov/sites/89cs/GNOC/_api/web/lists/getbytitle('DVList')/items?$top=5000&$orderby=DV%20asc";
        $.ajax({
          url: urlLoad,
          async: false,
          method: "GET",
          headers: {
            "Accept": "application/json;odata=verbose"
          },
          success: function (data) {
            var total = 0;
            var allResults = data.d.results;
            if (Number(allResults.length) > 0) {
              var select = document.getElementById('dv_select');
              for (var i = 0; i < Number(allResults.length); i++) {
                // looping through all results
                var opt = document.createElement('option');
                opt.innerHTML = allResults[i].DV;
                select.appendChild(opt);
              }
              $('.selectpicker').selectpicker('refresh');
            }
          },
          error: function (data) {
            //alert("Error: " + JSON.stringify(data));
          }
        });

        // Populate Ticket Categories
        var urlLoad = "https://intelshare.intelink.gov/sites/89cs/GNOC/_api/web/lists/getbytitle('Ticket_Categories')/items?$orderby=Category%20asc";
        $.ajax({
          url: urlLoad,
          async: false,
          method: "GET",
          headers: {
            "Accept": "application/json;odata=verbose"
          },
          success: function (data) {
            var total = 0;
            var allResults = data.d.results;
            if (Number(allResults.length) > 0) {
              var select = document.getElementById('category');
              for (var i = 0; i < Number(allResults.length); i++) {
                // looping through all results
                var opt = document.createElement('option');
                opt.innerHTML = allResults[i].Category;
                select.appendChild(opt);
              }
              $('.selectpicker').selectpicker('refresh');
            }
          },
          error: function (data) {
            //alert("Error: " + JSON.stringify(data));
          }
        });

        // Populate Aircraft Drop Down
        var urlLoad = "https://intelshare.intelink.gov/sites/89cs/GNOC/_api/web/lists/getbytitle('TailNumbers')/items?$top=5000&$orderby=Tail_x0020_Numbers%20asc";
        $.ajax({
          url: urlLoad,
          async: false,
          method: "GET",
          headers: {
            "Accept": "application/json;odata=verbose"
          },
          success: function (data) {
            var total = 0;
            var allResults = data.d.results;
            if (Number(allResults.length) > 0) {
              var select = document.getElementById('tail_number');
              for (var i = 0; i < Number(allResults.length); i++) {
                // looping through all results
                var opt = document.createElement('option');
                opt.innerHTML = allResults[i].Tail_x0020_Numbers;
                select.appendChild(opt);
              }
              $('.selectpicker').selectpicker('refresh');
            }
          },
          error: function (data) {
            //alert("Error: " + JSON.stringify(data));
          }
        });

        // Populate Fields
        $("#ticket_title").text(ticket_number);
        $("#ticket_number").val(ticket_number);
        var urlLoad = "https://intelshare.intelink.gov/sites/89cs/GNOC/_api/web/lists/getbytitle('Tickets')/items?$select=Author/Name,GNOC_Ticket_Number,Status,Date_Opened,DV,Impact_Level,Mission_Number,Leg,CSO,CCIR_Number,Tail_Number,Category,Sub_Category,Issue_Description,Id&$filter=GNOC_Ticket_Number eq '" + ticket_number + "'&$expand=Author";
        $.ajax({
          url: urlLoad,
          async: false,
          method: "GET",
          headers: {
            "Accept": "application/json;odata=verbose"
          },
          success: function (data) {
            var allResults = data.d.results;
            if (Number(allResults.length) > 0) {
              $("#status").val(allResults[0].Status);
              ticket_status = allResults[0].Status;

              $("#open_date").val(convertTheDate(allResults[0].Date_Opened, 1));

              $("#dv_select").val(allResults[0].DV);
              if (allResults[0].Impact_Level != "None" && allResults[0].Impact_Level != "Low" && allResults[0].Impact_Level != "Medium" && allResults[0].Impact_Level != "High")
                $("#impact_level").val("None");
              else
                $("#impact_level").val(allResults[0].Impact_Level);

              $("#mission_number").val(allResults[0].Mission_Number)
              $("#cso").val(allResults[0].CSO);

              checkMissionInfo(allResults[0].Mission_Number);

              $("#leg").val(allResults[0].Leg);

              $("#cso").val(allResults[0].CSO);
              if (allResults[0].CCIR)
                $("#ccir").val("Yes");
              else
                $("#ccir").val("No");

              $("#ccir_number").val(allResults[0].CCIR_Number);
              $("#tail_number").val(allResults[0].Tail_Number);
              $("#category").val(allResults[0].Category);
              $("#sub_category").val(allResults[0].Sub_Category);
              $("#issue_description").val(allResults[0].Issue_Description);
              $('.selectpicker').selectpicker('refresh');
              console.log("trying to assign name: " + allResults[0].Author.Name);
              var name = allResults[0].Author.Name.split('|');
              var fullName = name[2];
              var nameArr = fullName.split('.');
              if (nameArr[2] === undefined)
                nameArr[2] = nameArr[1];
              name = nameArr[0].toUpperCase() + " " + nameArr[2].toUpperCase();
              $("#createdBy").html("Created By: <b>" + name + "</b>");
              ticket_ID = allResults[0].Id;
            }
          },
          error: function (data) {
            //alert("Error: " + JSON.stringify(data));
          }

        });

        // Populate Files Uploaded
        var urlLoad = "https://intelshare.intelink.gov/sites/89cs/GNOC/_api/web/lists/getbytitle('ticketAttachments')/items?$select=ticket_number,Attachments,AttachmentFiles&$expand=AttachmentFiles&$filter=ticket_number eq '" + ticket_number + "'";
        $.ajax({
          url: urlLoad,
          async: false,
          method: "GET",
          headers: {
            "Accept": "application/json;odata=verbose"
          },
          success: function (data) {
            var total = 0;
            var allResults = data.d.results;
            if (Number(allResults.length) > 0) {
              var select = document.getElementById('add_files');
              var opt = document.createElement('span');
              opt.innerHTML = "<b>Uploaded Files:</b><br>";
              select.appendChild(opt);
              for (var i = 0; i < Number(allResults.length); i++) {
                var fileName = allResults[i].AttachmentFiles.results[0].FileName;
                var fileLink = "https://intelshare.intelink.gov/" + allResults[i].AttachmentFiles.results[0].ServerRelativeUrl;
                // looping through all results
                var opt = document.createElement('span');
                if (i == Number(allResults.length) - 1) {
                  opt.innerHTML = "<a href=\"" + fileLink + "\" target=\"_blank\" download><span data-feather=\"file-text\"></span>" + fileName + "</a>&nbsp;";
                }
                else {
                  opt.innerHTML = "<a href=\"" + fileLink + "\" target=\"_blank\" download><span data-feather=\"file-text\"></span>" + fileName + "</a>&nbsp;|&nbsp;";
                }
                select.appendChild(opt);
              }
            }
          }
        });


        // add update click handler
        if (checkPermissions("RURJVCBUSUNLRVQ=", false, false)) {
          $(document).on('click', '#ticket_submit', function () {
            // Disable Button
            var $this = $(this);
            var loadingText = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...';
            if ($(this).html() !== loadingText) {
              $this.data('original-text', $(this).html());
              $this.html(loadingText);
              $this.attr("disabled", true);
            }

            var ticket_number = $("#ticket_number").val();
            var dv = $("#dv_select").val();
            var tail_number = $("#tail_number").val();
            var mission_number = $("#mission_number").val();
            var leg = $("#leg").val();
            var impact_level = $("#impact_level").val();
            if (impact_level == "None")
              var dv_impact = false;
            else
              var dv_impact = true;

            var category = $("#category").val();
            var sub_category = $("#sub_category").val();
            var status = $("#status").val();;
            //var issue_description = $("#issue_description").val();
            var ccir = $("#ccir").val();
            if (ccir == "Yes")
              ccir = true;
            else
              ccir = false;
            var ccir_number = $("#ccir_number").val();
            var cso = $("#cso").val();

            //var itemProperties = {'ticket_number':ticket_number,'dv':dv,'date_opened':date.toJSON(),'tail_number':tail_number,'mission_number':mission_number,'dv_impact':dv_impact,'impact_level':impact_level,'category':category,'sub_category':sub_category,'status':status,'issue_description':issue_description,'ccir':ccir,'ccir_number':ccir_number,'cso':cso};
            var itemProperties = { 'GNOC_Ticket_Number': ticket_number, 'DV': dv, 'Tail_Number': tail_number, 'Mission_Number': mission_number, 'DV_Impact': dv_impact, 'Impact_Level': impact_level, 'Category': category, 'Sub_Category': sub_category, 'Status': status, 'CCIR': ccir, 'CCIR_Number': ccir_number, 'CSO': cso, 'Leg': leg };

            console.log(itemProperties);
            if (!$.trim($("#update_text").text()) && $("#update_text").val() != "") {
              // There is text in the update status box
              // first update ticket with new values
              updateTicket(hostUrl, itemProperties, function () {
                // Now add update to update DB
                itemProperties = { 'ticket_number': ticket_number, 'update': $("#update_text").val() };
                if (ticket_status == status) {
                  // only update message no status change
                  addUpdate(hostUrl, itemProperties, function () {
                    // Add update to main ticket DB
                    var newDate = new Date().toISOString();
                    itemProperties = { 'Update_Date': newDate, 'Last_Reported_Action': $("#update_text").val() };
                    updateTicket(hostUrl, itemProperties, function () {
                      // update successful.
                      alert("Ticket successfully updated.");
                      location.reload();
                    });
                  })
                }
                else {
                  // status has also changed
                  var status_update_text = "GNOC set ticket #" + ticket_number + " to " + status + ".";

                  // Add update for update text
                  itemProperties = { 'ticket_number': ticket_number, 'update': $("#update_text").val() };
                  addUpdate(hostUrl, itemProperties, function () {
                    // add update for status change
                    itemProperties = { 'ticket_number': ticket_number, 'update': status_update_text };
                    addUpdate(hostUrl, itemProperties, function () {
                      // Add update to main ticket DB
                      var newDate = new Date().toISOString();
                      itemProperties = { 'Update_Date': newDate, 'Last_Reported_Action': $("#update_text").val() };
                      updateTicket(hostUrl, itemProperties, function () {
                        // update successful.
                        alert("Ticket successfully updated.");
                        location.reload();
                      });
                    })
                  })

                }
              }, function () {
                alert("An error has occured. Please try again.");
              });
            }
            else if (ticket_status != status) {
              // Only the status message has changed. Update ticket status first
              updateTicket(hostUrl, itemProperties, function () {
                // Now add update message
                var status_update_text = "GNOC set ticket #" + ticket_number + " to " + status + ".";
                itemProperties = { 'ticket_number': ticket_number, 'update': status_update_text };
                addUpdate(hostUrl, itemProperties, function () {
                  alert("Ticket successfully updated.");
                  location.reload();
                })
              }, function () {
                alert("An error has occured. Please try again.");
              });
            }
            else {
              // No update text detected, perhaps a value of the ticket changed.
              updateTicket(hostUrl, itemProperties, function () {
                alert("Ticket successfully updated.");
                location.reload();
              });
            }
          });

          $(document).on('click', '#upload_files', function () {
            // Checking if document is uploaded
            if (document.getElementById("file_upload").files.length === 0) {
              alert("No file was selected.");
              return;
            }
            else {
              // reading uploaded file values and uploading each one
              var fileNameArr = document.getElementById("file_upload").files;
              console.log(fileNameArr);
              Array.prototype.forEach.call(fileNameArr, function (entry, index) {

                // first insert new value in the list
                var itemProperties = { 'ticket_number': ticket_number };
                CreateListItemWithDetails("ticketAttachments", itemProperties, index).then((id) => {
                  var itemId = id;
                  var filename = fileNameArr[index].name;
                  var file = document.getElementById("file_upload").files[index];


                  if (index == 0) {
                    var alerts = true;
                  }
                  uploadFile("ticketAttachments", itemId, filename, file, alerts);
                });
              });
            }
          });

          $(document).on('click', '#deleteTicket', function () {
            // Disable Button
            var $this = $(this);
            var loadingText = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...';
            if ($(this).html() !== loadingText) {
              $this.data('original-text', $(this).html());
              $this.html(loadingText);
              $this.attr("disabled", true);
            }
            deleteTicket(ticket_ID);
          });

          function getFileBuffer(file) {
            var deferred = $.Deferred();
            var reader = new FileReader();
            reader.onload = function (e) {
              deferred.resolve(e.target.result);
            }
            reader.onerror = function (e) {
              deferred.reject(e.target.error);
            }
            reader.readAsArrayBuffer(file);
            return deferred.promise();
          }


          function uploadFile(listName, id, fileName, file, alerts) {
            var deferred = $.Deferred();
            getFileBuffer(file).then(
              function (buffer) {
                var bytes = new Uint8Array(buffer);
                var queryUrl = "https://intelshare.intelink.gov/sites/89cs/GNOC/_api/web/lists/getbytitle('" + listName + "')/items(" + id + ")/AttachmentFiles/add(FileName='" + fileName + "')";
                $.ajax({
                  url: queryUrl,
                  type: "POST",
                  processData: false,
                  contentType: "application/json;odata=verbose",
                  data: buffer,
                  headers: {
                    "Accept": "application/json;odata=verbose",
                    "X-RequestDigest": digest,
                    "content-length": buffer.byteLength
                  }, success: onAttachmentSuccess(alerts),
                  error: onAttachmentFailure
                });
              },
              function (err) {
                deferred.reject(err);
              });
            return deferred.promise();
          }
          function onAttachmentSuccess(alerts) {
            console.log("Success");
            if (alerts) {
              alert("File(s) have been uploaded successfully.");
              location.reload();
            }
          }
          function onAttachmentFailure() {
            console.log("An error occured.");
          }

          // Create File Item
          const CreateListItemWithDetails = (listName, itemProperties) => {
            var itemType = GetItemTypeForListName(listName);
            itemProperties["__metadata"] = { "type": itemType };
            var itemId;
            return new Promise(function (resolve, reject) {
              $.ajax({
                url: "https://intelshare.intelink.gov/sites/89cs/GNOC/_api/web/lists/getbytitle('" + listName + "')/items",
                type: "POST",
                contentType: "application/json;odata=verbose",
                data: JSON.stringify(itemProperties),
                headers: {
                  "Accept": "application/json;odata=verbose",
                  "X-RequestDigest": digest
                },
                success: function (data) {
                  resolve(data.d.ID);
                  return;
                },
                error: function (err) {
                  reject(error("details: " + err));
                  return;
                }
              });
            });
          }
        }
        // Show Updates in list
        var urlLoad = "https://intelshare.intelink.gov/sites/89cs/GNOC/_api/web/lists/getbytitle('ticketUpdates')/items?$select=Author/Name,update_date,update,Created,Id&$orderby=Created%20desc&$filter=ticket_number eq '" + ticket_number + "'&$expand=Author";
        console.log("Searching for ticket number: " + ticket_number);
        $.ajax({
          url: urlLoad,
          async: false,
          method: "GET",
          headers: {
            "Accept": "application/json;odata=verbose"
          },
          success: function (data) {
            var allResults = data.d.results;
            console.log(allResults);
            var updates = [];
            if (Number(allResults.length) > 0) {
              for (var i = 0; i < Number(allResults.length); i++) {
                var created = allResults[i].Created;
                var update_date = allResults[i].update_date;
                var update = allResults[i].update;
                var updateId = allResults[i].Id;
                console.log(update);

                var name = allResults[i].Author.Name.split('|');
                var fullName = name[2];
                var nameArr = fullName.split('.');
                if (nameArr[2] === undefined)
                  nameArr[2] = nameArr[1];
                name = nameArr[0].toUpperCase() + " " + nameArr[2].toUpperCase();
                updates.push(created);
                updateIds.push(updateId);

                if (i == 0) {
                  if (update.includes("GNOC created ticket") || update.includes("GNOC set ticket"))
                    $("#ticket_update_log").append("<li class=\"list-group-item active\"><b>" + convertTheDate(update_date, 1) + "</b> - " + update + "</b><span class=\"float-right\" id=\"deleteUpdate\"><a href=\"javascript:deleteUpdate(" + updateId + ");\"><span style=\"color:#fff\" data-feather=\"trash-2\"></span></a></span></li>");
                  else
                    $("#ticket_update_log").append("<li class=\"list-group-item active\"><b>" + convertTheDate(update_date, 1) + " - " + name + ":</b> " + update + "</b><span class=\"float-right\" id=\"deleteUpdate\"><a href=\"javascript:deleteUpdate(" + updateId + ");\"><span style=\"color:#fff\" data-feather=\"trash-2\"></span></a></span></li>");

                }
                else {
                  if (update.includes("GNOC created ticket") || update.includes("GNOC set ticket"))
                    $("#ticket_update_log").append("<li class=\"list-group-item\"><b>" + convertTheDate(update_date, 1) + "</b> - " + update + "</b><span class=\"float-right\" id=\"deleteUpdate\"><a href=\"javascript:deleteUpdate(" + updateId + ");\"><span data-feather=\"trash-2\"></span></a></span></li>");
                  else
                    $("#ticket_update_log").append("<li class=\"list-group-item\"><b>" + convertTheDate(update_date, 1) + " - " + name + ":</b> " + update + "</b><span class=\"float-right\" id=\"deleteUpdate\"><a href=\"javascript:deleteUpdate(" + updateId + ");\"><span data-feather=\"trash-2\"></span></a></span></li>");
                }
                checkPermissions("REVMRVRFIFVQREFURQ==", "deleteUpdate", false);
              }
            }
          }
        });

        // Check if ticket is part of master ticket
        var urlLoad = "https://intelshare.intelink.gov/sites/89cs/GNOC/_api/web/lists/getbytitle('masterTickets')/items?$top=5000";
        $.ajax({
          url: urlLoad,
          async: false,
          method: "GET",
          headers: {
            "Accept": "application/json;odata=verbose"
          },
          success: function (data) {
            var allResults = data.d.results;
            if (Number(allResults.length) > 0) {
              var masterTickets = [];
              for (var i = 0; i < Number(allResults.length); i++) {
                if (allResults[i].ticket_list) {
                  var currentTickets = allResults[i].ticket_list.split(',');
                  var master_ticket = allResults[i].Title;
                  var master_ticket_id = allResults[i].Id;
                  if (currentTickets.includes(ticket_number)) {
                    // found match
                    $("#ticket_view").prepend("<div class=\"alert alert-info font-weight-bold\" role=\"alert\"><span data-feather=\"alert-circle\">&nbsp;</span>This ticket is part of master ticket <a href=\"./viewMasterTTS.html?ticket=" + master_ticket_id + "\">#" + master_ticket + "</a></div>");
                  }
                }
              }
            }
          },
          error: function (data) {
            //alert("Error: " + JSON.stringify(data));
          }
        });
        /*
        var urlLoad = "https://intelshare.intelink.gov/sites/89cs/GNOC/_api/search/query?querytext='" + ticket_number + " AND path:https://intelshare.intelink.gov/sites/89cs/GNOC/Lists/masterTickets/'";
        $.ajax({
          url: urlLoad,
          async: false,
          method: "GET",
          headers: {
            "Accept": "application/json;odata=verbose"
          },
          success: function (data) {
            var allResults = data.d.query.PrimaryQueryResult.RelevantResults.Table.Rows.results;
            console.log(data);
            if (Number(allResults.length) > 0) {
              var master_ticket = allResults[1].Cells.results[3].Value;
              var master_ticket_id = allResults[1].Cells.results[6].Value;
              master_ticket_id = master_ticket_id.split("=")[1];
              $("#ticket_view").prepend("<div class=\"alert alert-info font-weight-bold\" role=\"alert\"><span data-feather=\"alert-circle\">&nbsp;</span>This ticket is part of master ticket <a href=\"./viewMasterTTS.html?ticket=" + master_ticket_id + "\">#" + master_ticket + "</a></div>");
            }
          },
          error: function (data) {
            //alert("Error: " + JSON.stringify(data));
          }
        });*/
      }
      feather.replace();
    });

    function checkMissionInfo(mission_search) {
      var urlLoad = "https://intelshare.intelink.gov/sites/89cs/GNOC/_api/web/lists/getbytitle('Missions')/items?$filter=Mission_Number eq '" + mission_search + "'&$orderby=Created%20asc";
      var location = "";
      $.ajax({
        url: urlLoad,
        async: false,
        method: "GET",
        headers: {
          "Accept": "application/json;odata=verbose"
        },
        success: function (data) {
          var allResults = data.d.results;
          if (Number(allResults.length) > 0) {
            var select = document.getElementById('leg');
            for (var i = 0; i < Number(allResults.length); i++) {
              var opt = document.createElement('option');
              opt.value = i + 1;
              opt.innerHTML = i + 1;
              select.appendChild(opt);
              $('.selectpicker').selectpicker('refresh');
            }
          }
        },
        error: function (data) {
          //alert("Error: " + JSON.stringify(data));
        }
      });

    }
    function updateTicket(webUrl, itemProperties, success, failure) {
      listName = "Tickets";
      var itemType = GetItemTypeForListName(listName);
      itemProperties["__metadata"] = { "type": itemType };

      $.ajax({
        url: webUrl + "/_api/web/lists/getbytitle('" + listName + "')/items('" + ticket_ID + "')",
        type: "POST",
        contentType: "application/json;odata=verbose",
        data: JSON.stringify(itemProperties),
        headers: {
          "Accept": "application/json;odata=verbose",
          "X-RequestDigest": digest,
          "IF-MATCH": "*", // Overwrite changes
          "X-HTTP-Method": "MERGE" // update operation
        },
        success: function (data) {
          success(data);
        },
        error: function (data) {
          failure(data);
        }
      });
    }

    function deleteTicket(id) {
      $.ajax({
        url: hostUrl + "/_api/web/lists/getbytitle('Tickets')/items(" + id + ")",
        type: "POST",
        contentType: "application/json;odata=verbose",
        headers: {
          "Accept": "application/json;odata=verbose",
          "X-RequestDigest": digest,
          "IF-MATCH": "*",
          "X-HTTP-Method": "DELETE",
        },
        success: function (data) {
          // Now we need to delete all updates with ticket:
          for (var i = 0; i < updateIds.length; i++) {
            $.ajax({
              url: hostUrl + "/_api/web/lists/getbytitle('ticketUpdates')/items(" + updateIds[i] + ")",
              type: "POST",
              contentType: "application/json;odata=verbose",
              headers: {
                "Accept": "application/json;odata=verbose",
                "X-RequestDigest": digest,
                "IF-MATCH": "*",
                "X-HTTP-Method": "DELETE",
              },
              success: function (data) {
                if (i == updateIds.length) {
                  alert("Ticket deleted successfully.");
                  window.location.replace("./viewTickets.html");
                }
              }
            });
          }
        }
      });
    }

    function deleteUpdate(id) {
      $.ajax({
        url: hostUrl + "/_api/web/lists/getbytitle('ticketUpdates')/items(" + id + ")",
        type: "POST",
        contentType: "application/json;odata=verbose",
        headers: {
          "Accept": "application/json;odata=verbose",
          "X-RequestDigest": digest,
          "IF-MATCH": "*",
          "X-HTTP-Method": "DELETE",
        },
        success: function (data) {
          alert("Update deleted successfully.");
          location.reload();
        },
        error: function (data) {
          alert("An error has occured. Please try again.");
        }
      });
    }

    function addUpdate(webUrl, itemProperties, success, failure) {
      listName = "ticketUpdates";
      var itemType = GetItemTypeForListName(listName);
      itemProperties["__metadata"] = { "type": itemType };

      $.ajax({
        url: webUrl + "/_api/web/lists/getbytitle('" + listName + "')/items",
        type: "POST",
        contentType: "application/json;odata=verbose",
        data: JSON.stringify(itemProperties),
        headers: {
          "Accept": "application/json;odata=verbose",
          "X-RequestDigest": digest
        },
        success: function (data) {
          success(data);
        },
        error: function (data) {
          failure(data);
        }
      });
    }

    // Get List Item Type metadata
    function GetItemTypeForListName(name) {
      return "SP.Data." + name.charAt(0).toUpperCase() + name.split(" ").join("").slice(1) + "ListItem";
    }

    function convertTheDate(dateVar, offset) {
      // date conversion
      var convertDate = new Date(dateVar);
      var month = convertDate.getUTCMonth();
      month = ("0" + (convertDate.getMonth() + 1)).slice(-2)

      var date = convertDate.getDate();
      if (convertDate.getDate() < 10)
        date = "0" + convertDate.getDate();

      var minutes = convertDate.getUTCMinutes();
      if (convertDate.getUTCMinutes() < 10)
        minutes = "0" + convertDate.getUTCMinutes();

      var t = new Date();
      if (offset == 1) {
        var currentoffset = convertDate.getTimezoneOffset() * 60000;
        convertDate.setTime(convertDate.getTime() + currentoffset);
      }
      var hours = convertDate.getHours();

      if (convertDate.getHours() < 10)
        hours = "0" + hours;

      var dateString = month + "/" + date + "/" + convertDate.getFullYear() + " " + hours + ":" + minutes + "Z";
      return dateString;
    }

    // Get List Item Type metadata
    function GetItemTypeForListName(name) {
      return "SP.Data." + name.charAt(0).toUpperCase() + name.split(" ").join("").slice(1) + "ListItem";
    }

  </script>
</head>

<body>
  <nav class="navbar navbar-dark bg-dark flex-md-nowrap p-0">
    <a class="navbar-brand col-sm-3 col-md-2 mr-0" href="./index.html">
      <svg width="2em" height="2em" viewBox="0 0 16 16" class="bi bi-broadcast-pin" fill="currentColor"
        xmlns="http://www.w3.org/2000/svg">
        <path fill-rule="evenodd"
          d="M3.05 3.05a7 7 0 0 0 0 9.9.5.5 0 0 1-.707.707 8 8 0 0 1 0-11.314.5.5 0 0 1 .707.707zm2.122 2.122a4 4 0 0 0 0 5.656.5.5 0 0 1-.708.708 5 5 0 0 1 0-7.072.5.5 0 0 1 .708.708zm5.656-.708a.5.5 0 0 1 .708 0 5 5 0 0 1 0 7.072.5.5 0 1 1-.708-.708 4 4 0 0 0 0-5.656.5.5 0 0 1 0-.708zm2.122-2.12a.5.5 0 0 1 .707 0 8 8 0 0 1 0 11.313.5.5 0 0 1-.707-.707 7 7 0 0 0 0-9.9.5.5 0 0 1 0-.707zM6 8a2 2 0 1 1 2.5 1.937V15.5a.5.5 0 0 1-1 0V9.937A2 2 0 0 1 6 8z" />
      </svg> &nbsp;
      <b>GNOC DV Dashboard</b>
    </a>
  </nav>
  <div class="container-fluid">
    <div class="row">
      <nav class="col-md-2 d-none d-md-block bg-light sidebar">
        <div class="sidebar-sticky">
          <ul class="nav flex-column">
            <li class="nav-item" id="dashboard_div">
              <a class="nav-link" href="./index.html">
                <span data-feather="home"></span>
                Dashboard
              </a>
            </li>
            <li class="nav-item" id="flight_schedule_div">
              <a class="nav-link" href="./flightschedule.html">
                <span data-feather="clock"></span>
                Flight Schedule
              </a>
            </li>
            <li class="nav-item" id="contact_list_div">
              <a class="nav-link" href="./contactList.html">
                <span data-feather="phone"></span>
                Contact List
              </a>
            </li>
          </ul>
          <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted"
            id="tickets_header_div">
            <span>Trouble Tickets</span>
            <a class="d-flex align-items-center text-muted" href="./ticketSettings.html" id="ticket_settings_div">
              <span data-feather="settings"></span>
            </a>
          </h6>
          <ul class="nav flex-column mb-2">
            <li class="nav-item" id="create_tts_div">
              <a class="nav-link" href="./createTTS.html">
                <span data-feather="file"></span>
                Create a TTS
              </a>
            </li>
            <li class="nav-item" id="create_master_tts_div">
              <a class="nav-link" href="./createMasterTTS.html">
                <span data-feather="file"></span>
                Create a Master TTS
              </a>
            </li>
            <li class="nav-item" id="view_tickets_div">
              <a class="nav-link active" href="./viewTickets.html">
                <span data-feather="file-text"></span>
                View Tickets <span class="sr-only">(current)</span>
              </a>
            </li>
            <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted"
              id="flight_tickets_header_div">
              <span>Flight Tickets</span>
              <a class="d-flex align-items-center text-muted" href="./createFlightTicket.html"
                id="create_flight_ticket_icon_div">
                <span data-feather="plus-circle"></span>
              </a>
            </h6>
            <ul class="nav flex-column mb-2">
              <li class="nav-item" id="create_flight_ticket_div">
                <a class="nav-link" href="./createFlightTicket.html">
                  <span data-feather="file"></span>
                  Create a Flight Ticket
                </a>
              </li>
              <li class="nav-item" id="view_flight_tickets_div">
                <a class="nav-link" href="./viewFlightTickets.html">
                  <span data-feather="file-text"></span>
                  View Flight Tickets
                </a>
              </li>
              <li class="nav-item" id="view_missions_div">
                <a class="nav-link" href="./viewMissions.html">
                  <span data-feather="file-text"></span>
                  View Missions
                </a>
              </li>
            </ul>
            <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted"
              id="ccir_header_div">
              <span>CCIRs</span>
              <a class="d-flex align-items-center text-muted" href="./createCCIR.html" id="add_a_ccir_icon_div">
                <span data-feather="plus-circle"></span>
              </a>
            </h6>
            <ul class="nav flex-column mb-2">
              <li class="nav-item" id="add_a_ccir_div">
                <a class="nav-link" href="./createCCIR.html">
                  <span data-feather="file"></span>
                  Add a CCIR
                </a>
              </li>
              <li class="nav-item" id="view_ccirs_div">
                <a class="nav-link" href="./viewCCIRS.html">
                  <span data-feather="file-text"></span>
                  View CCIRs
                </a>
              </li>
            </ul>
            <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted"
              id="reports_header_div">
              <span>Reports</span>
            </h6>
            <ul class="nav flex-column mb-2">
              <li class="nav-item" id="24_hour_report_div">
                <a class="nav-link" href="./ticketReport.html">
                  <span data-feather="file-text"></span>
                  24 Hour Ticket Report
                </a>
              </li>
              <li class="nav-item" id="weekend_report_div">
                <a class="nav-link" href="./weekendTicketReport.html">
                  <span data-feather="file-text"></span>
                  Weekend Ticket Report
                </a>
              </li>
              <li class="nav-item" id="morning_slides_div">
                <a class="nav-link" href="./morningSlides.html">
                  <span data-feather="file-text"></span>
                  Morning Slides
                </a>
              </li>
              <li class="nav-item" id="personnel_stats_div">
                <a class="nav-link" href="./personnelStats.html">
                  <span data-feather="file-text"></span>
                  Personnel Stats
                </a>
              </li>
              <li class="nav-item" id="monthly_metrics_div">
                <a class="nav-link" href="./metrics.html">
                  <span data-feather="file-text"></span>
                  Monthly Metrics
                </a>
              </li>
              <li class="nav-item" id="permissions_div">
                <a class="nav-link" href="./permissions.html">
                  <span data-feather="file-text"></span>
                  Permissions
                </a>
              </li>
            </ul>
        </div>
      </nav>
      <main role="main" class="col-md-9 ml-sm-auto col-lg-10 px-4">
        <div
          class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
          <h1>View Ticket</h1>
        </div>
        <div class="col-md-12" id="ticket_view">
          <div class="card">
            <div class="card-header">
              <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-archive" fill="currentColor"
                xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd"
                  d="M0 2a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1v7.5a2.5 2.5 0 0 1-2.5 2.5h-9A2.5 2.5 0 0 1 1 12.5V5a1 1 0 0 1-1-1V2zm2 3v7.5A1.5 1.5 0 0 0 3.5 14h9a1.5 1.5 0 0 0 1.5-1.5V5H2zm13-3H1v2h14V2zM5 7.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5z" />
              </svg>
              <b>&nbsp;Ticket #<span id="ticket_title"></span>&nbsp;|&nbsp;STATUS:&nbsp;</b>
              <select class="selectpicker" data-style="btn-dark" id="status">
                <option>ASSIGNED</option>
                <option>FIXED</option>
                <option>HOLD</option>
                <option>CLOSED</option>
              </select>
              &nbsp;|&nbsp;<span id="createdBy"></span>
            </div>
            <div class="card-body">
              <form>
                <div class="row">
                  <div class="col">
                    <div class="form-group row">
                      <label for="open_date" class="col-sm-4 col-form-label">Open Date</label>
                      <div class="col-sm-8">
                        <input type="text" class="form-control" id="open_date" disabled>
                      </div>
                    </div>
                    <div class="form-group row">
                      <label for="ticket_number" class="col-sm-4 col-form-label">Ticket Number</label>
                      <div class="col-sm-8">
                        <input type="text" class="form-control" id="ticket_number" disabled>
                      </div>
                    </div>
                    <div class="form-group row">
                      <label for="dv_select" class="col-sm-4 col-form-label">DV</label>
                      <div class="col-sm-8">
                        <select class="selectpicker" id="dv_select" data-actions-box="true" data-live-search="true"
                          title="Choose one of the following...">
                        </select>
                      </div>
                    </div>
                    <div class="form-group row">
                      <label for="impact_level" class="col-sm-4 col-form-label">DV Impact</label>
                      <div class="col-sm-8">
                        <select class="selectpicker" id="impact_level" data-actions-box="true"
                          title="Choose one of the following...">
                          <option selected>None</option>
                          <option>Low</option>
                          <option>Medium</option>
                          <option>High</option>
                        </select>
                      </div>
                    </div>
                    <div class="form-group row">
                      <label for="mission_number" class="col-sm-4 col-form-label">Mission
                        Number</label>
                      <div class="col-sm-3">
                        <input type="text" class="form-control" id="mission_number" tabindex=3>
                      </div>
                      <label for="leg" class="col-sm-1 col-form-label">Leg</label>
                      <div class="col-sm-4">
                        <select class="selectpicker" id="leg" data-actions-box="true" tabindex=4
                          title="Choose one of the following...">
                          <option selected>N/A</option>
                        </select>
                      </div>
                    </div>
                    <div class="form-group row">
                      <label for="cso" class="col-sm-4 col-form-label">CSO Name</label>
                      <div class="col-sm-8">
                        <input type="email" class="form-control" id="cso" tabindex=5>
                      </div>
                    </div>
                    <div class="form-group row">
                      <label for="ccir" class="col-sm-4 col-form-label">CCIR</label>
                      <div class="col-sm-8">
                        <select class="selectpicker" id="ccir" data-actions-box="true"
                          title="Choose one of the following...">
                          <option>No</option>
                          <option>Yes</option>
                        </select>
                      </div>
                    </div>
                    <div class="form-group row">
                      <label for="ccir_number" class="col-sm-4 col-form-label">CCIR Number</label>
                      <div class="col-sm-8">
                        <input type="email" class="form-control" id="ccir_number">
                      </div>
                    </div>
                    <div class="form-group row">
                      <label for="tail_number" class="col-sm-4 col-form-label">Tail Number</label>
                      <div class="col-sm-8">
                        <select class="selectpicker" id="tail_number" data-actions-box="true" data-live-search="true"
                          title="Choose one of the following...">
                        </select>
                      </div>
                    </div>
                    <div class="form-group row">
                      <div class="col-sm-10">
                        <button type="button" id="ticket_submit" class="btn btn-primary">Update Ticket</button>
                      </div>
                    </div>
                    <div class="form-group row">
                      <div class="col-sm-10">
                        <button type="button" id="deleteTicket" class="btn btn-danger">Delete Ticket</button>
                      </div>
                    </div>
                  </div>
                  <div class="row col-md-6">
                    <div class="col">
                      <div class="form-group row">
                        <label for="category" class="col-sm-4 col-form-label">Category</label>
                        <div class="col-sm-8">
                          <select class="selectpicker" id="category" data-actions-box="true"
                            title="Choose one of the following...">
                          </select>
                        </div>
                      </div>
                      <div class="form-group row">
                        <label for="sub_category" class="col-sm-4 col-form-label">Sub Category</label>
                        <div class="col-sm-8">
                          <input type="text" class="form-control" id="sub_category">
                        </div>
                      </div>
                      <div class="form-group row">
                        <label for="issue_description" class="col-sm-4 col-form-label">Initial Description</label>
                        <textarea disabled class="form-control col-sm-8" id="issue_description" rows="10"></textarea>
                      </div>
                      <div class="form-group row">
                        <label for="issue_description" class="col-sm-4 col-form-label">Add Update</label>
                        <textarea class="form-control col-sm-8" id="update_text" rows="10"></textarea>
                      </div>
                    </div>
                  </div>
                </div>
              </form>
            </div>
          </div>
          <br>
          <div class="card" id="ticket_attachments_div">
            <div class="card-header">
              <span data-feather="file"></span>&nbsp;
              <b>Ticket Attachments</b>
            </div>
            <div class="card-body">
              <div class="col-md-12" id="add_files">

              </div><br>
              <div class="row col-md-12">
                <div class="col-md-4">
                  <input id="file_upload" type="file" class="filestyle" multiple>
                </div>
              </div>
              <br>
              <div class="row col-md-12">
                <div class="col-md-4">
                  <button type="button" id="upload_files" class="btn btn-primary">Upload Attachment(s)</button>
                </div>
              </div>
            </div>
          </div>
          <br>
          <div class="card">
            <div class="card-header">
              <span data-feather="clock"></span>&nbsp;
              <b>Ticket Timeline</b>
            </div>
            <div class="card-body">
              <ul id="ticket_update_log" class="list-group">
              </ul>
            </div>
          </div>
        </div>
      </main>
      <br />
      <footer class="py-4 col-md-2 bg-light" style="box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);">
        <div class="container-fluid">
          <div class="d-flex align-items-center justify-content-between small">
            <div class="text-muted">GNOC DV Dashboard - maintained by GNOC @ JBA<br />
              <a href="mailto:89CS.SCOV.VIP.COMM@us.af.mil">89CS.SCOV.VIP.COMM@us.af.mil</a>
            </div>
          </div>
        </div>
      </footer>
    </div>
  </div>
</body>

</html>